name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for changelog generation

      - name: Create Release with Changelog
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true # This creates the auto-generated changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-upload:
    name: Build and Upload
    needs: create-release # Depend on release creation
    strategy:
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: codecho
            asset_name: codecho-linux-amd64

          # Linux ARM64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary_name: codecho
            asset_name: codecho-linux-arm64

          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            binary_name: codecho
            asset_name: codecho-macos-amd64

          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            binary_name: codecho
            asset_name: codecho-macos-arm64

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: codecho.exe
            asset_name: codecho-windows-amd64.exe

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        run: |
          rustup show
          rustup target add ${{ matrix.target }}

      # Install cross-compilation tools for Linux ARM64
      - name: Install cross-compilation tools for Linux ARM64
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Generate deps cache key
        id: deps-cache-key
        run: |
          # Create cache key from Cargo.lock, excluding only our package's version line
          # This preserves cache across version bumps but invalidates on dependency changes
          DEPS_HASH=$(awk '
            /^\[\[package\]\]/ { in_package=1 }
            in_package && /^name = "codecho"$/ { in_codecho=1 }
            in_package && /^version = / && in_codecho { next }  # Skip version line in codecho package
            in_package && /^$/ { in_package=0; in_codecho=0 }  # Reset at package end
            { print }  # Print all other lines
          ' Cargo.lock | sha256sum | cut -d' ' -f1)
          echo "deps-hash=${DEPS_HASH}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/${{ matrix.target }}/release/deps
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-deps-${{ steps.deps-cache-key.outputs.deps-hash }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-deps-

      - name: Build binary
        run: cargo build --release --target ${{ matrix.target }} --bin codecho

      - name: Code sign macOS binary
        if: runner.os == 'macOS'
        run: |
          codesign --force --sign - target/${{ matrix.target }}/release/codecho
          codesign --verify --verbose target/${{ matrix.target }}/release/codecho

      - name: Prepare binary
        run: |
          cd target/${{ matrix.target }}/release
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            7z a -tzip ../../../${{ matrix.asset_name }}.zip ${{ matrix.binary_name }}
          else
            tar czf ../../../${{ matrix.asset_name }}.tar.gz ${{ matrix.binary_name }}
          fi
        shell: bash

      - name: Upload binary to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.asset_name }}.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-release-notes:
    name: Update Release Notes
    needs: build-and-upload
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release info
        id: get_release
        run: |
          RELEASE_INFO=$(gh api repos/${{ github.repository }}/releases/tags/${{ github.ref_name }})
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_INFO" | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release with installation instructions
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## üì¶ Installation

            ### macOS (Intel)
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/codecho-macos-amd64.tar.gz
            tar xzf codecho-macos-amd64.tar.gz
            xattr -d com.apple.quarantine codecho  # Remove macOS security warning*
            chmod +x codecho
            sudo mv codecho /usr/local/bin/
            ```

            ### macOS (Apple Silicon)
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/codecho-macos-arm64.tar.gz
            tar xzf codecho-macos-arm64.tar.gz
            xattr -d com.apple.quarantine codecho  # Remove macOS security warning*
            chmod +x codecho
            sudo mv codecho /usr/local/bin/
            ```

            **\* macOS binaries are not code-signed (not paying Apple $99/year for this free tool)**

            ### Linux (x86_64)
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/codecho-linux-amd64.tar.gz
            tar xzf codecho-linux-amd64.tar.gz
            chmod +x codecho
            sudo mv codecho /usr/local/bin/
            ```

            ### Linux (ARM64)
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/codecho-linux-arm64.tar.gz
            tar xzf codecho-linux-arm64.tar.gz
            chmod +x codecho
            sudo mv codecho /usr/local/bin/
            ```

            ### Windows
            Download `codecho-windows-amd64.exe.zip`, extract, and add to your PATH.

            ### üîß Verify Installation
            ```bash
            codecho --version
            ```

            ---

            ## üìù What's Changed
            ${{ steps.get_release.outputs.release_body }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
